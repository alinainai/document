##  HTTPS 抓包原理 - 中间人攻击
我们熟悉的 Fiddler、Charles 和 HttpCanary App 等抓包工具，其实都是采用了中间人攻击（Man-in-the-MiddleAttack，MITM）的方案： 将客户端的网络流量代理到 MITM 主机，再通过一系列的面板或工具将网络请求结构化地呈现出来。
如果拦截的是 HTTP 请求还好说，要是拦截的是 HTTPS 请求，首先就遇到第一个问题 —— 加密：

- 加密： 由于 HTTPS 通信中对称密钥 Master Secret 只有通信双方才持有，MITM 无法解密密文，导致在抓包工具上也只能看到一堆无意义的乱码。

要解决这个问题，只能想办法让 MITM 也获得这个对称密钥。此时，MITM 不仅要做流量拦截，还需要伪装成真实的客户端和服务端，与真实的通信双方分别建立独立的连接。我们来看下在中间人攻击下，HTTPS 的三阶段：

连接 1：客户端与中间人的 HTTPS 连接：

- CA 证书校验： 客户端与 MITM 握手，MITM 返回一个 “调包” 的 CA 证书（为了让客户端验证 CA 证书通过，需要提前在系统上安装 MITM 的证书）；
- 密钥协商： 客户端和 MITM 基于 “调包” 的公钥和私钥进行非对称加密通信，协商获得对称密钥；
- 数据传输： 客户端和 MITM 基于协商的对称密钥进行对称加密通信，此时 MITM 就可以解密出明文。

连接 2：中间人与服务端的 HTTPS 连接：

- CA 证书校验： MITM 与 服务端握手，服务端返回 CA 证书，由于服务端证书本来就是合法的，因此 MITM 可以拿到服务端公钥；
- 密钥协商： MITM 和服务端分别基于公钥和私钥进行非对称加密通信，协商获得 Master Secret 对称加密私钥；
- 数据传输： MITM 和服务端基于协商的对称密钥进行对称加密通信。

到这里，MITM 就成功与真实的客户端和服务端建立了独立的连接，发送的密文在 MITM 上就可以成功解密出来了。

>既然 HTTPS 可以被抓包，是否说明 HTTPS 不安全的？
>这需要区分不同使用场景下安全的口径，在用户不知情的场景 HTTPS 完全可以保证数据安全传输，而对于用户主动授权的场景，用户需要为这个主动的行为承担相应的安全风险。

<img width="600" alt="中间人攻击" src="https://user-images.githubusercontent.com/17560388/179738025-a56e29a7-85c0-4f27-9280-deb673456d8e.png">

## 总结一下实现 HTTPS 抓包的基本步骤：

- 部署 MITM 代理服务器；
- 通过代理等方式将网络流量归集到 MITM 主机；
- 客户端信任 MITM CA 证书；
- MITM 分别与客户端和服务端建立独立连接；
- MITM 解密客户端和服务端的通信，并结构化地呈现出来。

