一个 `class` 文件被加载到内存中需要经过 3 大步：装载、链接、初始化。

其中链接又可以细分为：验证、准备、解析 3 小步。

<img width="800" alt="类文件加载" src="https://user-images.githubusercontent.com/17560388/150710782-73b14a2f-80d2-4f0d-8977-79363b4b82e2.png">

## 一、装载

装载阶段的工作过程: `jvm` 虚拟机查找 `class` 文件并生成字节流，然后根据字节流创建 `java.lang.Class` 对象的过程。

这一过程主要完成以下 3 件事：

1. `classLoader` 通过一个类的全限定名（包名 + 类名）来查找 `class` 文件，并生成二进制字节流：其中 `class` 字节码文件的来源不一定是 `class` 文件，也可以是 `jar` 包、`zip` 包，甚至是来源于网络的字节流。
2. 把 `class` 文件的各个部分分别解析（parse）为 `jvm` 内部特定的数据结构，并存储在方法区。
3. 在内存中创建一个 `java.lang.Class` 类型的对象：接下来程序在运行过程中所有对该类的访问都通过这个`类对象`，也就是这个 `Class` 类型的类对象是提供给外界访问该类的接口。

装载时机

1. 隐式装载：在程序运行过程中，当碰到通过 new 等方式生成对象时，系统会隐式调用 ClassLoader 去装载对应的 class 到内存中；
2. 显示装载：在编写源代码时，主动调用 Class.forName() 等方法也会进行 class 装载操作，这种方式通常称为显示装载。

## 二、链接

### 2.1 验证

验证是链接的第一步，目的是为了确保 .class 文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危及虚拟机本身的安全。主要包含以下几个方面的检验。

1. 文件格式检验：检验字节流是否符合 class 文件格式的规范，并且能被当前版本的虚拟机处理。 
2. 元数据检验：对字节码描述的信息进行语义分析，以保证其描述的内容符合 Java 语言规范的要求。 
3. 字节码检验：通过数据流和控制流分析，确定程序语义是合法、符合逻辑的。 
4. 符号引用检验：符号引用检验可以看作是对类自身以外（常量池中的各种符号引用）的信息进行匹配性校验。

### 2.2 准备

为类中的静态变量分配内存，并为其设置 `0值`

比如：

```java
public static int value = 100;
```

在准备阶段，JVM 会为 value 分配内存，并将其设置为 0。而真正的值 100 是在初始化阶段设置。并且此阶段进行内存分配的仅包括类变量，而不包括实例变量（实例变量将会在对象实例化时随着对象一起分配在 Java 堆中）。

有一种情况比较特殊--静态常量，比如：

```java
public static final int value = 100;
```

以上代码会在准备阶段就为 value 分配内存，并设置为 100。

什么是默认`0值`：

基本类型（int、long、short、char、byte、boolean、float、double）的默认值为 0；

引用类型默认值是 null；

### 2.3 解析

把常量池中的符号引用转换为直接引用。在这一阶段，JVM 会将常量池中的类、接口名、字段名、方法名等转换为具体的内存地址。

## 三、初始化

执行类构造器<clinit>方法的过程，并真正初始化类变量
  
```java
public static int value = 100;
```

在准备阶段 value 被分配内存并设置为 0，在初始化阶段 value 就会被设置为 100。

### 3.1 初始化的时机 

对于装载阶段，JVM 并没有规范何时具体执行。但是对于初始化，JVM 规范中严格规定了 class 初始化的时机，主要有以下几种情况会触发 class 的初始化：

1. 虚拟机启动时，初始化包含 `main` 方法的主类；
2. 遇到 `new` 指令创建对象实例时，如果目标对象类没有被初始化则进行初始化操作；
3. 当遇到访问静态方法或者静态字段的指令时，如果目标对象类没有被初始化则进行初始化操作；
4. 子类的初始化过程如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化；
5. 使用反射 `API` 进行反射调用时，如果类没有进行过初始化则需要先触发其初始化；
6. 第一次调用 `java.lang.invoke.MethodHandle` 实例时，需要初始化 `MethodHandle` 指向方法所在的类。

### 3.2 初始化类变量

在初始化阶段，只会初始化与类相关的静态赋值语句和静态语句，也就是有 static 关键字修饰的信息，**而没有 static 修饰的语句块在实例化对象的时候才会执行**。

对象的初始化顺序如下：
  
```shell
静态变量/静态代码块 -> 普通代码块 -> 构造函数

1. 父类静态变量和静态代码块；
2. 子类静态变量和静态代码块；
3. 父类普通成员变量和普通代码块；
4. 父类的构造函数；
5. 子类普通成员变量和普通代码块；
6. 子类的构造函数。
```

